---
layout: post
title: Why we all are going to die by 2050: Visualizing Climate Change with Python
---

# Getting the Data

```python
import pandas as pd
import numpy as np
from plotly import express as px
from matplotlib import pyplot as plt
import seaborn as sns
```


```python
# getting the stations 
url = f"https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(url)
stations.head()
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>STNELEV</th>
      <th>NAME</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>57.7667</td>
      <td>11.8667</td>
      <td>18.0</td>
      <td>SAVE</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AE000041196</td>
      <td>25.3330</td>
      <td>55.5170</td>
      <td>34.0</td>
      <td>SHARJAH_INTER_AIRP</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AEM00041184</td>
      <td>25.6170</td>
      <td>55.9330</td>
      <td>31.0</td>
      <td>RAS_AL_KHAIMAH_INTE</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AEM00041194</td>
      <td>25.2550</td>
      <td>55.3640</td>
      <td>10.4</td>
      <td>DUBAI_INTL</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AEM00041216</td>
      <td>24.4300</td>
      <td>54.4700</td>
      <td>3.0</td>
      <td>ABU_DHABI_BATEEN_AIR</td>
    </tr>
  </tbody>
</table>
</div>




```python
# getting the country codes data
url = f"https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv"
countries = pd.read_csv(url)
countries.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FIPS 10-4</th>
      <th>ISO 3166</th>
      <th>Name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AF</td>
      <td>AF</td>
      <td>Afghanistan</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AX</td>
      <td>-</td>
      <td>Akrotiri</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL</td>
      <td>AL</td>
      <td>Albania</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AG</td>
      <td>DZ</td>
      <td>Algeria</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AQ</td>
      <td>AS</td>
      <td>American Samoa</td>
    </tr>
  </tbody>
</table>
</div>




```python
# getting the temperature data
temps = pd.read_csv("/Users/shreeshagarwal/Desktop/PIC16/Datasets/temps.csv")
temps.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>VALUE1</th>
      <th>VALUE2</th>
      <th>VALUE3</th>
      <th>VALUE4</th>
      <th>VALUE5</th>
      <th>VALUE6</th>
      <th>VALUE7</th>
      <th>VALUE8</th>
      <th>VALUE9</th>
      <th>VALUE10</th>
      <th>VALUE11</th>
      <th>VALUE12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>-89.0</td>
      <td>236.0</td>
      <td>472.0</td>
      <td>773.0</td>
      <td>1128.0</td>
      <td>1599.0</td>
      <td>1570.0</td>
      <td>1481.0</td>
      <td>1413.0</td>
      <td>1174.0</td>
      <td>510.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1962</td>
      <td>113.0</td>
      <td>85.0</td>
      <td>-154.0</td>
      <td>635.0</td>
      <td>908.0</td>
      <td>1381.0</td>
      <td>1510.0</td>
      <td>1393.0</td>
      <td>1163.0</td>
      <td>994.0</td>
      <td>323.0</td>
      <td>-126.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1963</td>
      <td>-713.0</td>
      <td>-553.0</td>
      <td>-99.0</td>
      <td>541.0</td>
      <td>1224.0</td>
      <td>1627.0</td>
      <td>1620.0</td>
      <td>1596.0</td>
      <td>1332.0</td>
      <td>940.0</td>
      <td>566.0</td>
      <td>-108.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1964</td>
      <td>62.0</td>
      <td>-85.0</td>
      <td>55.0</td>
      <td>738.0</td>
      <td>1219.0</td>
      <td>1442.0</td>
      <td>1506.0</td>
      <td>1557.0</td>
      <td>1221.0</td>
      <td>788.0</td>
      <td>546.0</td>
      <td>112.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1965</td>
      <td>44.0</td>
      <td>-105.0</td>
      <td>38.0</td>
      <td>590.0</td>
      <td>987.0</td>
      <td>1500.0</td>
      <td>1487.0</td>
      <td>1477.0</td>
      <td>1377.0</td>
      <td>974.0</td>
      <td>31.0</td>
      <td>-178.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Preparing the temps data i.e. stacking the temperature readings into one column 

def prepare_df(df):
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100
    return(df)

temps = prepare_df(temps)
temps.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>1</td>
      <td>-0.89</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>2</td>
      <td>2.36</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>3</td>
      <td>4.72</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>4</td>
      <td>7.73</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>5</td>
      <td>11.28</td>
    </tr>
  </tbody>
</table>
</div>



# Creating a Database


```python
import sqlite3 
```


```python
# create a new database
conn = sqlite3.connect("temps.db")
```


```python
# adding the three dataframes to the database

# adding temps.csv
df_iter = pd.read_csv("/Users/shreeshagarwal/Desktop/PIC16/Datasets/temps.csv", chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False)
    
# adding the stations data frame
stations.to_sql("stations", conn, if_exists = "replace", index = False)

# adding the countries data frame
countries.to_sql("countries", conn, if_exists = "replace", index = False)

```


```python
# getting the details of every table in the database

cursor = conn.cursor()

cursor.execute("SELECT sql FROM sqlite_master WHERE type='table';")

for result in cursor.fetchall():
    print(result[0])
```

    CREATE TABLE "temperatures" (
    "ID" TEXT,
      "Year" INTEGER,
      "Month" INTEGER,
      "Temp" REAL
    )
    CREATE TABLE "stations" (
    "ID" TEXT,
      "LATITUDE" REAL,
      "LONGITUDE" REAL,
      "STNELEV" REAL,
      "NAME" TEXT
    )
    CREATE TABLE "countries" (
    "FIPS 10-4" TEXT,
      "ISO 3166" TEXT,
      "Name" TEXT
    )



```python
def query_climate_database(country, year_begin, year_end, month):
    
    cmd = \
    f"""
    SELECT S.name, S.latitude, S.longitude, C.name, T.year, T.month, T.temp
    FROM temperatures T 
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON SUBSTRING(T.id,1, 2) = C.`FIPS 10-4` 
    WHERE T.year >= {year_begin} AND T.year <= {year_end} AND T.month == {month} AND C.name == "{country}"
    """
    return pd.read_sql_query(cmd, conn)
```


```python
india_temps = query_climate_database("India", 1980, 2020, 1)
print(india_temps.shape)
india_temps.head()
```

    (34672, 7)





<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Name</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
  </tbody>
</table>
</div>




```python
import sklearn
from sklearn.linear_model import LinearRegression

import plotly.graph_objects as go
from plotly.io import write_html


def coef(data_group):
    x = data_group[["Year"]] # 2 brackets because X should be a df
    y = data_group["Temp"]   # 1 bracket because y should be a series
    LR = LinearRegression()
    LR.fit(x, y)
    return LR.coef_[0]


def temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, **kwargs):
    
    # SQL query to get the daataset with country, year_begin, year_end, month specifications
    temps = query_climate_database(country, year_begin, year_end, month)
    
    # removing the stations with less than min_obs
    df = temps.groupby(["NAME"])[["Temp"]].aggregate(len) 
    names = (df[df["Temp"] > 30].reset_index())["NAME"]
    
    temps = temps[temps["NAME"].isin(np.array(names))]
    
    
    # creating linear coefficients 
    coefs = temps.groupby("NAME").apply(coef)
    coefs = coefs.reset_index()
    
    
    # merging coefs with latitude and longitude columns 
    df = pd.merge(coefs, temps, on = ["NAME"])
    df[0] = df[0].round(5)
    df = df.rename(columns = {0  : "Estimated Yearly Increase in Temperature (°C)"}) 
    df = df.drop(["Name","Year","Temp","Month"], axis = 1)  # drop extra columns 
    df = df.drop_duplicates(subset=['NAME']) # drop the duplicate entries
    
    # creating the figure
    color_map = px.colors.diverging.RdGy_r
    
    month_dict = { 1: "January", 2: "February", 3: "March", 4: "April", 5: "May", 6: "June", 7: "July", 8: "August", 9: "September", 10: "October", 11: "November", 12: "December"}
    
    fig = px.scatter_mapbox(df,
                            lat = "LATITUDE",
                            lon = "LONGITUDE",
                            hover_name = "NAME",
                            color = "Estimated Yearly Increase in Temperature (°C)",
                            mapbox_style = "carto-positron",
                            color_continuous_scale = color_map,
                            zoom = 2,
                            title = f"Estimated Yearly Increase in Temperature (°C) in {month_dict[1]} for stations in {country}",
                            **kwargs
                            )
    
    write_html(fig, "Fig1.html")
    
    return fig
```


```python
temperature_coefficient_plot("India", 1980, 2020, 1, 30)
```

# Plot 2


```python
def plot2_sql_query(country, year_begin, year_end):
    
    cmd = \
    f"""
    SELECT C.name, T.year, T.month, T.temp
    FROM temperatures T 
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON SUBSTRING(T.id,1, 2) = C.`FIPS 10-4` 
    WHERE T.year >= {year_begin} AND T.year <= {year_end} AND C.name == "{country}"
    """
    
    return pd.read_sql_query(cmd, conn)

 
def z_score_calc(x):
    m = np.mean(x)
    s = np.std(x)
    return (x - m)/s
```


```python
def plot_heatmap(country, year_begin, year_end, z_score = False):
    
    # get the dataframe
    df = plot2_sql_query(country, 2000,2020)
    
    # perform some dataframe manipulations to calculate average temperature by year and month 
    df = df.sort_values(by=['Year', 'Month'])
    df = df.reset_index()
    df = df.drop(["index"], axis = 1)
    
    # PLOT THE Z-SCORE HEATMAP 
    if z_score == True:
        
        # perform some dataframe manipulations to calculate z_scores and add the column to the df
        df["z"] = df.groupby(["Year","Month"])["Temp"].transform(z_score_calc)
        df = df.groupby(["Year","Month"])["z"].aggregate(np.mean).to_frame()
        df = df.reset_index()
        
        # make the final df for plotting
        plot_df = df.pivot("Year","Month","z")

        fig, ax = plt.subplots(figsize= (17,13))
        ax.set_title(f"Heatmap showing Temperature (°C) z-scores of {country} between {year_begin} and {year_end} for each Month")
        fig = sns.heatmap(plot_df, ax = ax, linewidths=.5, cmap = "coolwarm")
        
        plt.savefig("Fig2.png")
        
        return fig

    # PLOT THE AVG TEMPERATURE HEATMAP
    
    df = df.groupby(["Year","Month"]).aggregate(np.mean)
    df = df.reset_index()
    
    # make the final df for plotting
    plot_df = df.pivot("Year","Month","Temp")
    
    # plot the heatmap
    fig, ax = plt.subplots(figsize= (17,13))
    ax.set_title(f"Heatmap showing Average Temperature (°C) of {country} between {year_begin} and {year_end} for each Month")
    fig = sns.heatmap(plot_df, ax = ax, linewidths=.5, cmap= "coolwarm", annot = True)
    
    plt.savefig("Fig3.png")
    
    return fig
```


```python
plot_heatmap("Iceland", 2000,2020)
```




    <AxesSubplot:title={'center':'Heatmap showing Average Temperature (°C) of Iceland between 2000 and 2020 for each Month'}, xlabel='Month', ylabel='Year'>




#![png](output_18_1.png)
    

```python
plot_heatmap("Iceland", 2000,2020, z_score = True)
```




    <AxesSubplot:title={'center':'Heatmap showing Temperature (°C) z-scores of Iceland between 2000 and 2020 for each Month'}, xlabel='Month', ylabel='Year'>




    
# ![png](output_19_1.png)
    


# Plot3

Boxplot grid of change of median temperature by decade in one country.



```python
def plot3_sql_query(country, decade_start, decade_end):
    
    """
    Performs a SQL query to obtain temperature data of the specified country between specified dates.
    
    Note: Input to decade_start, decade_end should be the last year of the decade eg 2019.
    
    """
    
    cmd = \
    f"""
    SELECT C.name, T.year, T.temp
    FROM temperatures T 
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON SUBSTRING(T.id,1, 2) = C.`FIPS 10-4` 
    WHERE T.year >= {decade_start} AND T.year <= {decade_end} AND C.name == "{country}"
    """
    
    return pd.read_sql_query(cmd, conn)
```


```python
df = plot3_sql_query("Japan",1970, 2019)
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Year</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-6.86</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-6.42</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-4.95</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Japan</td>
      <td>1970</td>
      <td>4.56</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Japan</td>
      <td>1970</td>
      <td>10.72</td>
    </tr>
  </tbody>
</table>
</div>




```python
years = np.arange(1970,2020).tolist()
decades = [years[i:i+10] for i in range(0, len(years), 10)]
decades
    
```




    [[1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979],
     [1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989],
     [1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999],
     [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009],
     [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]]



dff = df.copy()
dff['decade'] = dff['Year'] // 10 * 10


```python
df2 = pd.DataFrame()

for i in range(0,len(decades)):
    df_d1 = df[df["Year"].isin(decades[i])]
    df_d1["Decade"] = f"{decades[i][0]} - {decades[i][9]}"
    frames = [df2, df_d1]
    df2 = pd.concat(frames)
    
df2
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Year</th>
      <th>Temp</th>
      <th>Decade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-6.86</td>
      <td>1970 - 1979</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-6.42</td>
      <td>1970 - 1979</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Japan</td>
      <td>1970</td>
      <td>-4.95</td>
      <td>1970 - 1979</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Japan</td>
      <td>1970</td>
      <td>4.56</td>
      <td>1970 - 1979</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Japan</td>
      <td>1970</td>
      <td>10.72</td>
      <td>1970 - 1979</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1039099</th>
      <td>Japan</td>
      <td>2014</td>
      <td>4.85</td>
      <td>2010 - 2019</td>
    </tr>
    <tr>
      <th>1039100</th>
      <td>Japan</td>
      <td>2015</td>
      <td>3.95</td>
      <td>2010 - 2019</td>
    </tr>
    <tr>
      <th>1039101</th>
      <td>Japan</td>
      <td>2015</td>
      <td>4.85</td>
      <td>2010 - 2019</td>
    </tr>
    <tr>
      <th>1039102</th>
      <td>Japan</td>
      <td>2015</td>
      <td>8.05</td>
      <td>2010 - 2019</td>
    </tr>
    <tr>
      <th>1039103</th>
      <td>Japan</td>
      <td>2015</td>
      <td>14.04</td>
      <td>2010 - 2019</td>
    </tr>
  </tbody>
</table>
<p>1039104 rows × 4 columns</p>
</div>




```python
df3 = df2.copy()
avg_temps = df3.groupby(["Decade"])["Temp"].aggregate(np.mean).to_frame()

```


```python
sns.lineplot(data = avg_temps, x = "Decade",  y = "Temp")
```




    <AxesSubplot:xlabel='Decade', ylabel='Temp'>



    
# ![png](output_27_1.png)
    



```python
fig, ax = plt.subplots(figsize= (15,12))

fig = sns.lineplot(data = df2, x = "Year", y = "Temp", hue = "Decade")
fig
```



    
# ![png](output_28_1.png)
    


```python
def plot_boxplots(country, decade_begin, decade_end):
    
    # getting the data 
    df = plot3_sql_query(country, decade_begin, decade_end)
    
    # making the decades column
    years = np.arange(decade_begin, decade_end + 1).tolist()
    decades = [years[i:i+10] for i in range(0, len(years), 10)]
    
    # empty dataframe for stacking 
    df2 = pd.DataFrame()

    for i in range(0,len(decades)):
        df_d1 = df[df["Year"].isin(decades[i])]
        df_d1["Decade"] = f"{decades[i][0]} - {decades[i][9]}"
        frames = [df2, df_d1]
        df2 = pd.concat(frames)
        
    fig = px.box(df2, 
                 y = "Decade", 
                 x = "Temp",
                 title= f"Boxplot showing Temperature (°C) of {country} for each decade between {decade_begin} and {decade_end + 1}",)
    
    write_html(fig, "Fig4.html")
    
    return fig
```


```python
plot_boxplots("Iceland", 1970, 2019)
```
